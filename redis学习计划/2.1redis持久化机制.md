# redis持久化机制

Redis 提供了两种主要的持久化机制，用于将内存中的数据保存到磁盘，确保数据在重启后不会丢失。这两种机制分别是 **RDB（Redis Database）** 和 **AOF（Append-Only File）**。它们可以单独使用，也可以结合使用。

---

### 1. **RDB（Redis Database）**
RDB 是 Redis 的默认持久化方式，它通过创建数据集的**快照（snapshot）**来保存某一时刻的完整数据。

#### **工作原理**
- Redis 会**定期**将内存中的数据以二进制格式保存到磁盘（默认文件名为 `dump.rdb`）。
- 快照的触发方式：
  - **手动触发**：执行 `SAVE`（阻塞）或 `BGSAVE`（后台异步）命令。
  - **自动触发**：根据配置文件 `redis.conf` 中的 `save` 规则（如 `save 900 1` 表示 900 秒内至少有 1 个键被修改时触发）。

#### **优点**
- **高性能**：RDB 是二进制文件，恢复速度快。
- **紧凑存储**：文件体积小，适合备份和灾难恢复。
- **适合大规模数据**：恢复大数据集时比 AOF 更快。

#### **缺点**
- **可能丢失数据**：如果 Redis 崩溃，最后一次快照之后的数据会丢失。
- **频繁快照影响性能**：大数据集时 `BGSAVE` 可能占用较多 CPU 和内存。

#### **配置示例（redis.conf）**
```conf
save 900 1      # 900秒内至少1个键变化时触发
save 300 10     # 300秒内至少10个键变化时触发
save 60 10000   # 60秒内至少10000个键变化时触发
dbfilename dump.rdb  # RDB文件名
dir ./               # 存储路径
```

---

### 2. **AOF（Append-Only File）**
AOF 通过记录**所有写操作命令**（以文本形式追加到文件）来实现持久化，类似数据库的 WAL（Write-Ahead Log）。

#### **工作原理**
- 每个写命令都会追加到 AOF 文件末尾（默认文件名为 `appendonly.aof`）。
- Redis 重启时通过**重放 AOF 文件中的命令**恢复数据。
- 为避免文件过大，Redis 支持 **AOF 重写（AOF Rewrite）**：
  - 基于当前数据生成新的 AOF 文件，移除冗余命令（如多次修改同一键）。

#### **同步策略（appendfsync）**
- **`always`**：每个命令都同步到磁盘（最安全，但性能最差）。
- **`everysec`**（默认）：每秒同步一次（平衡安全性和性能）。
- **`no`**：由操作系统决定何时同步（最快，但可能丢失数据）。

#### **优点**
- **数据安全性高**：最多丢失 1 秒的数据（`everysec` 配置）。
- **可读性强**：AOF 是文本文件，便于人工分析或修复。
- **支持实时持久化**：每次写操作都会记录。

#### **缺点**
- **文件体积大**：AOF 文件通常比 RDB 大。
- **恢复速度慢**：重放 AOF 日志比加载 RDB 慢。
- **写性能略低**：高并发写入时可能影响吞吐量。

#### **配置示例（redis.conf）**
```conf
appendonly yes           # 启用AOF
appendfilename "appendonly.aof"
appendfsync everysec     # 同步策略
auto-aof-rewrite-percentage 100  # AOF文件增长100%时触发重写
auto-aof-rewrite-min-size 64mb   # AOF文件最小重写大小
```

---

### 3. **混合持久化（RDB + AOF）**
Redis 4.0 后支持混合持久化，结合两者的优势：
- **AOF 文件包含两部分**：
  1. 全量数据的 RDB 格式快照。
  2. 增量操作的 AOF 格式命令。
- **优点**：
  - 恢复速度快（先加载 RDB 快照，再重放少量 AOF 命令）。
  - 数据安全性接近 AOF。

#### **配置**
```conf
aof-use-rdb-preamble yes  # 启用混合持久化
```

---

### 4. **如何选择持久化方式？**
| **场景**                | **推荐方式**            |
| ----------------------- | ----------------------- |
| 允许分钟级数据丢失      | RDB                     |
| 需要更高数据安全性      | AOF（`everysec`）       |
| 希望快速恢复+低丢失风险 | 混合持久化（RDB + AOF） |
| 仅用于缓存              | 关闭持久化（`save ""`） |

---

### 5. **注意事项**
- **监控磁盘空间**：AOF 文件可能持续增长，需定期检查。
- **备份策略**：定期将 RDB/AOF 文件备份到异地。
- **性能权衡**：AOF 的 `always` 模式会显著降低吞吐量。

通过合理配置 RDB 和 AOF，可以在数据安全性和性能之间取得平衡。