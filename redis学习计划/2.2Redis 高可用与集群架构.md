# Redis 高可用与集群架构

Redis 提供了多种方式来实现高可用性和集群部署，以下是主要方案的详细介绍：

## 1. Redis Sentinel (哨兵模式) - 高可用方案

**核心功能**：

- 监控：持续检查主从节点是否正常运行
- 通知：当Redis实例出现问题时通知管理员
- 自动故障转移：主节点故障时自动将从节点提升为主节点
- 配置提供者：为客户端提供当前主节点地址

**部署要点**：

- 至少需要3个Sentinel实例以确保健壮性
- 当多数Sentinel认为主节点不可达时触发故障转移
- 支持配置主从节点的故障转移策略

**优点**：

- 配置相对简单
- 自动故障转移，提高可用性
- 官方推荐的高可用方案

## 2. Redis Cluster - 分布式集群方案

**核心特性**：

- 数据分片：自动将数据分散到多个节点（16384个哈希槽）
- 高可用性：每个分片有主从复制，支持自动故障转移
- 去中心化：节点间通过Gossip协议通信

**部署要求**：

- 至少需要3个主节点（生产环境建议至少6节点：3主3从）
- 每个主节点应有至少一个从节点
- 使用CRC16算法计算键的哈希槽位置

**优点**：

- 真正的分布式解决方案
- 可线性扩展至1000个节点
- 自动数据分片和重新平衡
- 部分节点故障不影响整体服务

## 3. 主从复制 (Replication)

**基础高可用方案**：

- 一个主节点，多个从节点
- 从节点异步复制主节点数据
- 主节点故障时需手动提升从节点为主节点

**特点**：

- 配置简单
- 读写分离（从节点可处理读请求）
- 无自动故障转移

## 4. 方案对比

| 特性         | 主从复制 | Sentinel | Cluster |
| ------------ | -------- | -------- | ------- |
| 自动故障转移 | ❌        | ✅        | ✅       |
| 数据分片     | ❌        | ❌        | ✅       |
| 水平扩展     | ❌        | ❌        | ✅       |
| 配置复杂度   | 简单     | 中等     | 复杂    |
| 适用场景     | 小规模   | 高可用   | 大规模  |

## 5. 最佳实践建议

1. **中小规模部署**：
   - 使用Redis Sentinel实现高可用
   - 2-3个Sentinel节点监控1个主从组

2. **大规模部署**：
   - 使用Redis Cluster
   - 规划好分片数量和主从比例
   - 确保网络延迟在可接受范围内

3. **运维注意事项**：
   - 监控所有Redis实例和Sentinel
   - 设置合理的持久化策略（AOF+RDB）
   - 规划好容量，避免内存溢出
   - 定期进行故障转移测试

4. **客户端要求**：
   - 使用支持集群/Sentinel的客户端
   - 处理重定向和连接变化
   - 实现适当的重试逻辑

## 6. 高级主题

**跨数据中心部署**：

- 使用Redis Geo-Replication
- 考虑网络延迟和分区容忍性
- 异步复制带来的数据一致性挑战

**性能优化**：

- 合理设置hash-tag确保相关键在同一节点
- 调整TCP内核参数优化网络性能
- 使用Pipeline减少网络往返

**安全考虑**：

- 启用认证（requirepass）
- 加密数据传输（SSL/TLS）
- 限制网络访问（防火墙规则）

选择适合您业务规模和数据量需求的方案，对于大多数生产环境，Redis Sentinel或Redis Cluster是最佳选择。